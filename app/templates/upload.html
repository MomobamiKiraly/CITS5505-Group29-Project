<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Upload Prediction</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
    <style>
        .step {
            display: none;
        }

        .step.active {
            display: block;
        }

        .team,
        .driver {
            border: 2px solid transparent;
            transition: 0.3s;
            cursor: pointer;
        }

        .selected {
            border-color: #007bff;
        }
    </style>
</head>

<body class="bg-light p-5">
    <div class="container bg-white p-4 shadow rounded">
        <h2>Upload Your F1 Prediction</h2>
        <form method="POST">
            <!-- Step 1: Personal Info -->
            <div class="step active" id="step1">
                <h4>Step 1: Personal Info</h4>
                <input class="form-control mb-2" type="text" name="full_name" placeholder="Full Name" required>
                <input class="form-control mb-2" type="number" name="age" placeholder="Age" required>
                <button class="btn btn-primary mt-2" type="button" onclick="nextStep()">Next</button>
            </div>

            <!-- Step 2: Team & Driver -->
            <div class="step" id="step2">
                <h4>Step 2: Choose Team</h4>
                <div class="row text-center">
                    {% for team in teams %}
                    <div class="col-6 mb-3">
                        <img src="{{ team.image_url }}" class="team img-fluid p-2" onclick="selectTeam(this)"
                            data-value="{{ team.name }}">
                    </div>
                    {% endfor %}
                </div>
                <input type="hidden" name="team" id="teamInput">

                <div id="driverSection" style="display: none;">
                    <h4 class="mt-4">Choose Driver</h4>
                    <div class="row text-center" id="driverContainer"></div>
                    <input type="hidden" name="driver" id="driverInput">
                </div>

                <button class="btn btn-secondary mt-3" type="button" onclick="prevStep()">Back</button>
                <button class="btn btn-primary mt-3" type="button" onclick="nextStep()">Next</button>
            </div>

            <!-- Step 3: Predictions -->
            <div class="step" id="step3">
                <h4>Step 3: Predictions</h4>

                <label for="race_winner" class="form-label">Who will win the next race?</label>
                <select class="form-select mb-3" name="race_winner" id="race_winner" required>
                    <option value="">-- None --</option>
                    {% for team in teams %}
                    <option value="{{ team.name }}">{{ team.name }}</option>
                    {% endfor %}
                </select>

                <label class="form-label">Who will be the top 3 finishers?</label>
                <div class="mb-3">
                    <select class="form-select" id="top_3_select">
                        <option value="">-- None --</option>
                        {% for team, drivers in drivers_by_team.items() %}
                        {% for driver in drivers %}
                        <option value="{{ driver.name }} ({{ team }})">{{ driver.name }} ({{ team }})</option>
                        {% endfor %}
                        {% endfor %}
                    </select>
                    <div id="top_3_tags" class="mt-2"></div>
                    <input type="hidden" name="top_3" id="top_3_input">
                </div>

                <label for="fastest_lap" class="form-label">Who will be the fastest lap driver?</label>
                <select class="form-select mb-3" name="fastest_lap" id="fastest_lap" required>
                    <option value="">-- None --</option>
                    {% for team, drivers in drivers_by_team.items() %}
                    {% for driver in drivers %}
                    <option value="{{ driver.name }} ({{ team }})">{{ driver.name }} ({{ team }})</option>
                    {% endfor %}
                    {% endfor %}
                </select>

                <button class="btn btn-secondary" type="button" onclick="prevStep()">Back</button>
                <button class="btn btn-success" type="submit">Submit</button>
            </div>

        </form>
    </div>

    <script>
        let current = 0;
        const steps = document.querySelectorAll('.step');
        const driversByTeam = {{ drivers_by_team | tojson }};

        function nextStep() {
            if (current < steps.length - 1) {
                steps[current].classList.remove('active');
                current++;
                steps[current].classList.add('active');
            }
        }

        function prevStep() {
            if (current > 0) {
                steps[current].classList.remove('active');
                current--;
                steps[current].classList.add('active');
            }
        }

        function selectTeam(el) {
            document.querySelectorAll('.team').forEach(e => e.classList.remove('selected'));
            el.classList.add('selected');
            document.getElementById('teamInput').value = el.dataset.value;

            // Show driver section and update drivers
            document.getElementById('driverSection').style.display = 'block';
            updateDrivers(el.dataset.value);
        }

        function updateDrivers(teamName) {
            const driverContainer = document.getElementById('driverContainer');
            driverContainer.innerHTML = '';

            if (driversByTeam[teamName]) {
                driversByTeam[teamName].forEach(driver => {
                    const col = document.createElement('div');
                    col.className = 'col-6 mb-3';

                    const name = document.createElement('p');
                    name.innerText = driver.name;
                    name.className = 'fw-bold';

                    const img = document.createElement('img');
                    img.src = driver.image_url;
                    img.alt = driver.name;
                    img.className = 'driver img-fluid p-2';
                    img.setAttribute('data-value', driver.name);
                    img.onclick = function () {
                        document.querySelectorAll('.driver').forEach(d => d.classList.remove('selected'));
                        img.classList.add('selected');
                        document.getElementById('driverInput').value = driver.name;
                    };

                    col.appendChild(name);
                    col.appendChild(img);
                    driverContainer.appendChild(col);
                });
            }
        }
    </script>
    <script>
        // Top 3 tag logic
        const top3Select = document.getElementById('top_3_select');
        const top3TagsContainer = document.getElementById('top_3_tags');
        const top3Input = document.getElementById('top_3_input');
        let top3Selections = [];

        top3Select.addEventListener('change', function () {
            const selected = this.value;
            if (selected && !top3Selections.includes(selected) && top3Selections.length < 3) {
                top3Selections.push(selected);
                updateTop3Tags();
                top3Select.value = '';
            }
        });

        function updateTop3Tags() {
            top3TagsContainer.innerHTML = '';
            top3Selections.forEach((item, index) => {
                const tag = document.createElement('span');
                tag.className = 'badge bg-primary me-1';
                tag.innerHTML = `${item} <span class="ms-1" style="cursor:pointer;" onclick="removeTop3(${index})">&times;</span>`;
                top3TagsContainer.appendChild(tag);
            });
            top3Input.value = top3Selections.join(';');
        }

        function removeTop3(index) {
            top3Selections.splice(index, 1);
            updateTop3Tags();
        }
    </script>

</body>

</html>
